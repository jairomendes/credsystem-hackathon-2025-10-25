.PHONY: help run test build docker-build docker-push docker-run clean

# VariÃ¡veis
IMAGE_NAME=participantes/velocistas-da-pilha
TAG=latest

help: ## Mostra este help
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-15s\033[0m %s\n", $$1, $$2}'

run: ## Executa localmente
	@echo "ğŸš€ Executando API..."
	go run cmd/api/main.go

test: ## Testa o CSV loader
	@echo "ğŸ§ª Testando loader..."
	go run cmd/test_csv/main.go

test-api: ## Testa a API (requer API rodando)
	@echo "ğŸ§ª Testando API..."
	chmod +x test_api.sh
	./test_api.sh

build: ## Build do binÃ¡rio
	@echo "ğŸ”¨ Building..."
	go build -o main cmd/api/main.go

docker-build: ## Build da imagem Docker
	@echo "ğŸ³ Building Docker image..."
	docker build -t $(IMAGE_NAME):$(TAG) .

docker-push: docker-build ## Push da imagem para registry
	@echo "ğŸ“¤ Pushing to registry..."
	docker push $(IMAGE_NAME):$(TAG)

docker-run: ## Executa com Docker Compose
	@echo "ğŸ³ Starting with Docker Compose..."
	docker-compose up -d
	@echo "âœ… Container rodando!"
	@echo "ğŸ“Š Logs: docker-compose logs -f"

docker-stop: ## Para containers
	@echo "ğŸ›‘ Stopping containers..."
	docker-compose down

docker-logs: ## Mostra logs
	docker-compose logs -f

clean: ## Limpa arquivos temporÃ¡rios
	@echo "ğŸ§¹ Cleaning..."
	rm -f main
	go clean

check: ## Valida estrutura do projeto
	@echo "âœ… Verificando estrutura..."
	@test -f assets/intents_pre_loaded.csv && echo "  âœ… CSV encontrado" || echo "  âŒ CSV nÃ£o encontrado"
	@test -f Dockerfile && echo "  âœ… Dockerfile encontrado" || echo "  âŒ Dockerfile nÃ£o encontrado"
	@test -f docker-compose.yml && echo "  âœ… docker-compose.yml encontrado" || echo "  âŒ docker-compose.yml nÃ£o encontrado"
	@test -f go.mod && echo "  âœ… go.mod encontrado" || echo "  âŒ go.mod nÃ£o encontrado"
	@test -d internal/classifier && echo "  âœ… classifier encontrado" || echo "  âŒ classifier nÃ£o encontrado"
	@test -d internal/storage && echo "  âœ… storage encontrado" || echo "  âŒ storage nÃ£o encontrado"
	@echo "âœ… ValidaÃ§Ã£o completa!"